<div class="container mx-auto px-4 py-8">
  <div class="max-w-lg mx-auto bg-white dark:bg-gray-800 rounded-lg shadow p-8">
    <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6 flex items-center gap-2">
      <i class="fas fa-user-plus"></i> Add New User
    </h1>

    <% if (typeof errors !== 'undefined' && errors.length > 0) { %>
      <div class="mb-6 flex flex-col gap-2 px-4 py-3 rounded-lg bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 border border-red-200 dark:border-red-700">
        <div class="flex items-center gap-2">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Please fix the following errors:</strong>
        </div>
        <ul class="list-disc pl-6">
          <% errors.forEach(error => { %>
            <li><%= error %></li>
          <% }) %>
        </ul>
      </div>
    <% } %>

    <form method="POST" action="/admin/users/add" class="space-y-6" data-no-ajax="true">
      <div>
        <label for="cep_id" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">CEP ID <span class="text-red-500">*</span></label>
        <input type="text" id="cep_id" name="cep_id"
          value="<%= typeof formData !== 'undefined' ? formData.cep_id : '' %>"
          required
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
          placeholder="Enter CEP ID">
        <div id="cep-validation" class="text-xs mt-1"></div>
      </div>

      <div>
        <label for="name" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">Name <span class="text-red-500">*</span></label>
        <input type="text" id="name" name="name"
          value="<%= typeof formData !== 'undefined' ? formData.name : '' %>"
          required
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
          placeholder="Enter user name">
      </div>

      <div>
        <label for="email" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">Email <span class="text-red-500">*</span></label>
        <input type="email" id="email" name="email"
          value="<%= typeof formData !== 'undefined' ? formData.email : '' %>"
          required
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
          placeholder="Enter email address">
      </div>

      <div>
        <label for="password" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">Password <span class="text-red-500">*</span></label>
        <input type="password" id="password" name="password"
          required
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
          placeholder="Enter password">
        <small class="text-gray-500 dark:text-gray-400">Password must be at least 6 characters long</small>
      </div>

      <div>
        <label for="confirm_password" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">Confirm Password <span class="text-red-500">*</span></label>
        <input type="password" id="confirm_password" name="confirm_password"
          required
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
          placeholder="Re-enter password">
      </div>

      <div>
        <label class="block font-semibold mb-3 text-gray-700 dark:text-gray-200">Assign Roles</label>
        <div class="max-h-48 overflow-y-auto border border-gray-300 dark:border-gray-700 rounded-md p-3 bg-gray-50 dark:bg-gray-900">
          <% if (typeof roles !== 'undefined' && roles.length > 0) { %>
            <% roles.forEach(role => { %>
              <% if (
                (role.name === 'developer' && can('dev.view')) ||
                (role.name !== 'developer')
              ) { %>
              <div class="flex items-start gap-2 mb-2">
                <input type="checkbox" id="role_<%= role.id %>" name="selectedRoles" value="<%= role.id %>"
                  class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                  <%= role.name === 'user' ? 'checked' : '' %>>
                <div class="flex-1">
                  <label for="role_<%= role.id %>" class="text-sm font-medium text-gray-900 dark:text-gray-100 cursor-pointer">
                    <%= role.display_name %>
                  </label>
                  <% if (role.description) { %>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1"><%= role.description %></p>
                  <% } %>
                </div>
              </div>
              <% } %>
            <% }) %>
          <% } else { %>
            <p class="text-gray-500 dark:text-gray-400 text-sm">No roles available</p>
          <% } %>
        </div>
        <small class="text-gray-500 dark:text-gray-400">Select one or more roles for this user. The 'User' role is selected by default.</small>
      </div>

      <div class="flex gap-2 mt-4">
        <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md transition flex items-center gap-2">
          <i class="fas fa-user-plus"></i> Create User
        </button>
        <a href="/admin/users" class="px-6 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 font-semibold rounded-md transition flex items-center gap-2">
          <i class="fas fa-times"></i> Cancel
        </a>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  const passwordField = document.getElementById('password');
  const confirmPasswordField = document.getElementById('confirm_password');
  const cepIdField = document.getElementById('cep_id');
  const cepValidation = document.getElementById('cep-validation');
  let cepCheckTimeout;

  // Real-time CEP ID validation
  cepIdField.addEventListener('input', function() {
    const newValue = this.value.trim();

    // Clear existing timeout
    if (cepCheckTimeout) {
      clearTimeout(cepCheckTimeout);
    }

    // Clear validation message
    cepValidation.innerHTML = '';
    cepValidation.className = 'text-xs mt-1';

    // Don't validate if empty
    if (newValue.length === 0) {
      return;
    }

    if (newValue.length < 3) {
      cepValidation.className = 'text-xs mt-1 text-yellow-700 dark:text-yellow-300';
      cepValidation.innerHTML = '<i class="fas fa-info-circle"></i> CEP ID should be at least 3 characters';
      return;
    }

    // Show checking state
    cepValidation.className = 'text-xs mt-1 text-blue-700 dark:text-blue-300';
    cepValidation.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking availability...';

    // Check for availability after delay
    cepCheckTimeout = setTimeout(() => {
      checkCepIdAvailability(newValue);
    }, 800);
  });

  function checkCepIdAvailability(cepId) {
    fetch('/admin/check-cep-availability', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        cep_id: cepId
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.available) {
        cepValidation.className = 'text-xs mt-1 text-green-700 dark:text-green-300';
        cepValidation.innerHTML = '<i class="fas fa-check"></i> CEP ID is available';
        clearFieldError(cepIdField);
      } else {
        cepValidation.className = 'text-xs mt-1 text-red-700 dark:text-red-300';
        let msg = '<i class="fas fa-times"></i> This CEP ID is already taken';
        if (data.user && data.user.name) {
          msg += ` by <span class="font-semibold">${data.user.name}</span>`;
        }
        cepValidation.innerHTML = msg;
        showFieldError(cepIdField, 'This CEP ID is already taken');
      }
    })
    .catch(error => {
      console.error('Error checking CEP ID availability:', error);
      cepValidation.className = 'text-xs mt-1 text-red-700 dark:text-red-300';
      cepValidation.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Unable to verify CEP ID availability. Please try again.';
    });
  }

  form.addEventListener('submit', function(e) {
    const password = passwordField.value;
    const confirmPassword = confirmPasswordField.value;

    if (password !== confirmPassword) {
      e.preventDefault();
      alert('Passwords do not match!');
      confirmPasswordField.focus();
      return false;
    }

    if (password.length < 6) {
      e.preventDefault();
      alert('Password must be at least 6 characters long!');
      passwordField.focus();
      return false;
    }
  });

  function showFieldError(field, message) {
    field.classList.add('border-red-500', 'focus:ring-red-500');
  }

  function clearFieldError(field) {
    field.classList.remove('border-red-500', 'focus:ring-red-500');
  }
});
</script>
