<!-- filepath: src/views/admin/licanse.ejs -->
<div class="container mx-auto px-4 py-8">
    <a href="/" class="back-link inline-flex items-center text-blue-600 hover:text-blue-800 mb-6">
        <i class="fas fa-arrow-left mr-2"></i>
        Back to Dashboard
    </a>

    <div class="header mb-8">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-200">
            <i class="fas fa-certificate mr-3"></i> License Management
        </h1>
        <p class="text-gray-600 dark:text-gray-400">Manage and validate your AssetTrack license</p>
    </div>

    <!-- Flash Messages -->
    <% if (messages && messages.success && messages.success.length > 0) { %>
        <div class="alert alert-success bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
            <i class="fas fa-check-circle mr-2"></i>
            <%= messages.success[0] %>
        </div>
    <% } %>

    <% if (messages && messages.error && messages.error.length > 0) { %>
        <div class="alert alert-danger bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <%= messages.error[0] %>
        </div>
    <% } %>

    <% if (messages && messages.info && messages.info.length > 0) { %>
        <div class="alert alert-info bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4">
            <i class="fas fa-info-circle mr-2"></i>
            <%= messages.info[0] %>
        </div>
    <% } %>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <!-- License Status Section -->
        <div class="license-status mb-6 p-4 rounded-lg border-2 <%= licenseInfo && licenseInfo.status === 'active' ? 'border-green-500 bg-green-50' : licenseInfo && licenseInfo.status === 'missing' ? 'border-yellow-500 bg-yellow-50' : 'border-red-500 bg-red-50' %>">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <% if (licenseInfo && licenseInfo.status === 'active') { %>
                        <i class="fas fa-check-circle text-green-500 text-2xl mr-3"></i>
                        <div>
                            <h3 class="text-lg font-semibold text-green-800">License Active</h3>
                            <p class="text-green-600"><%= licenseInfo.msg || 'License is valid and active' %></p>
                        </div>
                    <% } else if (licenseInfo && licenseInfo.status === 'missing') { %>
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mr-3"></i>
                        <div>
                            <h3 class="text-lg font-semibold text-yellow-800">License Missing</h3>
                            <p class="text-yellow-600"><%= licenseInfo.msg || 'No license key configured' %></p>
                        </div>
                    <% } else { %>
                        <i class="fas fa-times-circle text-red-500 text-2xl mr-3"></i>
                        <div>
                            <h3 class="text-lg font-semibold text-red-800">License Invalid</h3>
                            <p class="text-red-600"><%= licenseInfo ? licenseInfo.msg : 'License status unknown' %></p>
                        </div>
                    <% } %>
                </div>
                <div class="text-right">
                    <i class="fas fa-shield-alt text-4xl opacity-30"></i>
                </div>
            </div>
        </div>

        <!-- License Information -->
        <% if (licenseInfo && (licenseInfo.status === 'active' || currentLicense)) { %>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <label class="block text-sm font-medium text-gray-600 dark:text-gray-300">Company</label>
                <div class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                    <%= licenseInfo.company || (currentLicense ? currentLicense.company_name : 'N/A') %>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <label class="block text-sm font-medium text-gray-600 dark:text-gray-300">Valid Until</label>
                <div class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                    <%= licenseInfo.valid_until || (currentLicense ? (currentLicense.valid_until ? new Date(currentLicense.valid_until).toLocaleDateString() : 'N/A') : 'N/A') %>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <label class="block text-sm font-medium text-gray-600 dark:text-gray-300">Last Checked</label>
                <div class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                    <%= currentLicense && currentLicense.last_validated ? new Date(currentLicense.last_validated).toLocaleString() : 'Never' %>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <label class="block text-sm font-medium text-gray-600 dark:text-gray-300">Status</label>
                <div class="text-lg font-semibold">
                    <span class="px-2 py-1 rounded-full text-sm <%= licenseInfo && licenseInfo.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                        <%= licenseInfo ? licenseInfo.status.toUpperCase() : 'UNKNOWN' %>
                    </span>
                </div>
            </div>
        </div>
        <% } %>

        <!-- Current License Key Display -->
        <div class="mb-6">
            <h3 class="text-lg font-semibold mb-3">
                <i class="fas fa-key mr-2"></i>
                Current License Key
            </h3>
            <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg font-mono text-sm">
                <%= currentLicense && currentLicense.license_key ? currentLicense.license_key.substring(0, 20) + '...' : 'No license key configured' %>
            </div>
        </div>

        <!-- License Management Form -->
        <div class="border-t pt-6">
            <h3 class="text-lg font-semibold mb-4">
                <i class="fas fa-cog mr-2"></i>
                Update License
            </h3>

            <form method="POST" action="/admin/license/validate" class="space-y-4">
                <div>
                    <label for="licenseKey" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        License Key
                    </label>
                    <input type="text"
                           id="licenseKey"
                           name="licenseKey"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Enter your license key"
                           required>
                </div>

                <div class="flex flex-wrap gap-2">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition-colors">
                        <i class="fas fa-check mr-2"></i>
                        Validate License
                    </button>

                    <button type="button" onclick="testConnection()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md transition-colors">
                        <i class="fas fa-plug mr-2"></i>
                        Test Connection
                    </button>

                    <% if (currentLicense) { %>
                    <button type="button" onclick="removeLicense()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md transition-colors">
                        <i class="fas fa-trash mr-2"></i>
                        Remove License
                    </button>
                    <% } %>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function testConnection() {
    const btn = event.target;
    const originalText = btn.innerHTML;

    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
    btn.disabled = true;

    fetch('/admin/license/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalText;
        btn.disabled = false;

        if (data.success) {
            showAlert('Connection test successful!', 'success');
        } else {
            showAlert('Connection test failed: ' + data.message, 'error');
        }
    })
    .catch(error => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        showAlert('Connection test failed: ' + error.message, 'error');
    });
}

function removeLicense() {
    if (confirm('Are you sure you want to remove the current license key? This will disable the application for non-admin users.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/license/remove';
        document.body.appendChild(form);
        form.submit();
    }
}

function showAlert(message, type) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg max-w-md`;

    if (type === 'success') {
        alertDiv.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
        alertDiv.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
    } else {
        alertDiv.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
        alertDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${message}`;
    }

    document.body.appendChild(alertDiv);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}
</script>
