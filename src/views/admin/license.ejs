<!-- License Management Page -->
<div class="container mx-auto px-4 py-8">
  <!-- Header -->
  <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-8 flex items-center gap-2">
    <i class="fas fa-certificate"></i> License Management
  </h1>

  <!-- Flash Messages -->
  <% if (messages && messages.success && messages.success.length > 0) { %>
    <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded-lg p-4 mb-6">
      <div class="flex items-center">
        <i class="fas fa-check-circle text-green-500 mr-3"></i>
        <span class="text-green-800 dark:text-green-200"><%= messages.success[0] %></span>
      </div>
    </div>
  <% } %>

  <% if (messages && messages.error && messages.error.length > 0) { %>
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-lg p-4 mb-6">
      <div class="flex items-center">
        <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
        <span class="text-red-800 dark:text-red-200"><%= messages.error[0] %></span>
      </div>
    </div>
  <% } %>

  <% if (messages && messages.info && messages.info.length > 0) { %>
    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg p-4 mb-6">
      <div class="flex items-center">
        <i class="fas fa-info-circle text-blue-500 mr-3"></i>
        <span class="text-blue-800 dark:text-blue-200"><%= messages.info[0] %></span>
      </div>
    </div>
  <% } %>

  <!-- License Status Overview -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Main Status Card -->
    <div class="lg:col-span-2">
      <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <i class="fas fa-shield-check text-indigo-600"></i>
          License Status
        </h3>

        <div class="p-4 rounded-lg border-2 <%= licenseInfo && licenseInfo.status === 'active' ? 'border-green-500 bg-green-50 dark:bg-green-900/20' : licenseInfo && licenseInfo.status === 'missing' ? 'border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20' : 'border-red-500 bg-red-50 dark:bg-red-900/20' %>">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <% if (licenseInfo && licenseInfo.status === 'active') { %>
                <i class="fas fa-check-circle text-green-500 text-3xl mr-4"></i>
                <div>
                  <h4 class="text-lg font-semibold text-green-800 dark:text-green-200">License Active</h4>
                  <p class="text-green-600 dark:text-green-300"><%= licenseInfo.msg || 'License is valid and active' %></p>
                </div>
              <% } else if (licenseInfo && licenseInfo.status === 'missing') { %>
                <i class="fas fa-exclamation-triangle text-yellow-500 text-3xl mr-4"></i>
                <div>
                  <h4 class="text-lg font-semibold text-yellow-800 dark:text-yellow-200">License Missing</h4>
                  <p class="text-yellow-600 dark:text-yellow-300"><%= licenseInfo.msg || 'No license key configured' %></p>
                </div>
              <% } else { %>
                <i class="fas fa-times-circle text-red-500 text-3xl mr-4"></i>
                <div>
                  <h4 class="text-lg font-semibold text-red-800 dark:text-red-200">License Invalid</h4>
                  <p class="text-red-600 dark:text-red-300"><%= licenseInfo ? licenseInfo.msg : 'License status unknown' %></p>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistics Card -->
    <div>
      <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
          <i class="fas fa-chart-bar text-indigo-600"></i>
          Statistics
        </h3>

        <% if (licenseStats) { %>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">Total Licenses:</span>
              <span class="font-semibold text-gray-900 dark:text-white"><%= licenseStats.total_licenses %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">Active:</span>
              <span class="font-semibold text-green-600"><%= licenseStats.active_licenses %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">Expired:</span>
              <span class="font-semibold text-red-600"><%= licenseStats.expired_licenses %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-400">Invalid:</span>
              <span class="font-semibold text-orange-600"><%= licenseStats.invalid_licenses %></span>
            </div>
            <% if (licenseStats.days_until_expiry !== null) { %>
              <div class="flex justify-between pt-2 border-t border-gray-200 dark:border-gray-700">
                <span class="text-gray-600 dark:text-gray-400">Days Until Expiry:</span>
                <span class="font-semibold <%= licenseStats.days_until_expiry <= 30 ? 'text-red-600' : licenseStats.days_until_expiry <= 90 ? 'text-yellow-600' : 'text-green-600' %>">
                  <%= licenseStats.days_until_expiry %> days
                </span>
              </div>
            <% } %>
          </div>
        <% } else { %>
          <p class="text-gray-500 dark:text-gray-400 text-sm">Statistics not available</p>
        <% } %>
      </div>
    </div>
  </div>

  <!-- License Information Grid -->
  <% if (licenseInfo && (licenseInfo.status === 'active' || currentLicense)) { %>
    <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
        <i class="fas fa-info-circle text-indigo-600"></i>
        License Details
      </h3>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Company</label>
          <div class="text-lg font-semibold text-gray-900 dark:text-gray-100">
            <%= licenseInfo.company || (currentLicense ? currentLicense.company : 'N/A') %>
          </div>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Valid Until</label>
          <div class="text-lg font-semibold text-gray-900 dark:text-gray-100">
            <%
              let validUntil = licenseInfo.valid_until || (currentLicense ? currentLicense.valid_until : null);
              if (validUntil) {
                const date = new Date(validUntil);
                %>
                <%= date.toLocaleDateString() %>
              <% } else { %>
                N/A
              <% } %>
          </div>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Last Checked</label>
          <div class="text-lg font-semibold text-gray-900 dark:text-gray-100">
            <%
              let lastChecked = currentLicense ? currentLicense.last_checked : null;
              if (lastChecked) {
                const date = new Date(lastChecked);
                %>
                <%= date.toLocaleString() %>
              <% } else { %>
                Never
              <% } %>
          </div>
        </div>

        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
          <label class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Status</label>
          <div class="text-lg font-semibold">
            <span class="px-3 py-1 rounded-full text-sm <%= licenseInfo && licenseInfo.status === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' %>">
              <%= licenseInfo ? licenseInfo.status.toUpperCase() : 'UNKNOWN' %>
            </span>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Validation Results -->
  <% if (validationResult) { %>
    <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
        <i class="fas fa-check-double text-indigo-600"></i>
        Database Validation
      </h3>

      <div class="flex items-center gap-4 mb-4">
        <div class="flex items-center gap-2">
          <i class="fas <%= validationResult.validation_result === 'PASSED' ? 'fa-check-circle text-green-500' : 'fa-exclamation-triangle text-red-500' %>"></i>
          <span class="font-semibold <%= validationResult.validation_result === 'PASSED' ? 'text-green-800 dark:text-green-200' : 'text-red-800 dark:text-red-200' %>">
            <%= validationResult.validation_result %>
          </span>
        </div>
        <span class="text-gray-500">|</span>
        <span class="text-gray-600 dark:text-gray-400">
          <%= validationResult.active_licenses %> active, <%= validationResult.expired_licenses %> expired
        </span>
      </div>

      <% if (validationResult.issues_found && validationResult.issues_found.length > 0) { %>
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-lg p-4">
          <h4 class="font-semibold text-red-800 dark:text-red-200 mb-2">Issues Found:</h4>
          <ul class="list-disc pl-6 space-y-1">
            <% validationResult.issues_found.forEach(issue => { %>
              <li class="text-red-700 dark:text-red-300 text-sm"><%= issue %></li>
            <% }) %>
          </ul>
        </div>
      <% } %>
    </div>
  <% } %>

  <!-- Current License Key Display -->
  <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
      <i class="fas fa-key text-indigo-600"></i>
      Current License Key
    </h3>

    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg font-mono text-sm break-all">
      <%= currentLicense && currentLicense.license_key ? currentLicense.license_key.substring(0, 40) + '...' : 'No license key configured' %>
    </div>
  </div>

  <!-- License Management Form -->
  <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
      <i class="fas fa-cog text-indigo-600"></i>
      Manage License
    </h3>

    <form method="POST" action="/admin/license/validate" class="space-y-6">
      <div>
        <label for="licenseKey" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
          License Key
        </label>
        <textarea id="licenseKey" name="licenseKey" rows="3"
                  class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl text-base transition focus:outline-none focus:border-indigo-900 bg-white dark:bg-gray-900 text-gray-900 dark:text-white font-mono"
                  placeholder="Enter your license key"
                  required></textarea>
        <small class="text-gray-500 dark:text-gray-400 mt-1">Paste your complete license key here</small>
      </div>

      <div class="flex flex-wrap gap-3">
        <button type="submit"
                class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2">
          <i class="fas fa-check"></i>
          Validate License
        </button>

        <button type="button" onclick="testConnection()"
                class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2">
          <i class="fas fa-plug"></i>
          Test Connection
        </button>

        <button type="button" onclick="testDatabase()"
                class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2">
          <i class="fas fa-database"></i>
          Test Database
        </button>

        <% if (currentLicense) { %>
          <button type="button" onclick="removeLicense()"
                  class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2">
            <i class="fas fa-trash"></i>
            Remove License
          </button>
        <% } %>
      </div>
    </form>
  </div>
</div>

<script>
function testConnection() {
    const btn = event.target;
    const originalText = btn.innerHTML;

    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
    btn.disabled = true;

    fetch('/admin/license/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalText;
        btn.disabled = false;

        if (data.success) {
            showNotification('Connection test successful!', 'success');
        } else {
            showNotification('Connection test failed: ' + data.message, 'error');
        }
    })
    .catch(error => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        showNotification('Connection test failed: ' + error.message, 'error');
    });
}

function testDatabase() {
    const btn = event.target;
    const originalText = btn.innerHTML;

    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';
    btn.disabled = true;

    fetch('/admin/license/test-database', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalText;
        btn.disabled = false;

        if (data.success) {
            let message = 'Database test successful!\\n\\n';
            if (data.results.validation) {
                message += `Validation: ${data.results.validation.validation_result}\\n`;
                message += `Licenses: ${data.results.validation.active_licenses} active, ${data.results.validation.expired_licenses} expired\\n`;
            }
            if (data.results.statistics) {
                message += `Statistics: ${data.results.statistics.total_licenses} total licenses\\n`;
                if (data.results.statistics.current_license_company) {
                    message += `Company: ${data.results.statistics.current_license_company}\\n`;
                    message += `Days until expiry: ${data.results.statistics.days_until_expiry}\\n`;
                }
            }
            showNotification(message, 'success');
        } else {
            showNotification('Database test failed: ' + data.error, 'error');
        }
    })
    .catch(error => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        showNotification('Database test failed: ' + error.message, 'error');
    });
}

function removeLicense() {
    if (confirm('Are you sure you want to remove the current license key? This will disable the application for non-admin users.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/license/remove';
        document.body.appendChild(form);
        form.submit();
    }
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-md transition-all duration-300 transform translate-x-full`;

    if (type === 'success') {
        notification.classList.add('bg-green-50', 'border', 'border-green-200', 'text-green-800');
        notification.innerHTML = `
            <div class="flex items-start">
                <i class="fas fa-check-circle text-green-500 mr-3 mt-0.5"></i>
                <div class="flex-1">
                    <pre class="whitespace-pre-wrap text-sm">${message}</pre>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-green-500 hover:text-green-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    } else {
        notification.classList.add('bg-red-50', 'border', 'border-red-200', 'text-red-800');
        notification.innerHTML = `
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-red-500 mr-3 mt-0.5"></i>
                <div class="flex-1">
                    <pre class="whitespace-pre-wrap text-sm">${message}</pre>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    }

    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);

    // Auto-remove after 10 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 10000);
}
</script>
