<!-- Items Table Block -->
<% if (items && items.length > 0) { %>
  <div id="itemsTableBlock">
    <div id="itemsTableContainer" class="overflow-x-auto bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="bg-gradient-to-r from-gray-100 to-gray-200 dark:from-gray-900 dark:to-gray-800 text-gray-700 dark:text-gray-200 border-b-2 border-gray-300 dark:border-gray-600">
            <th class="px-4 py-4 text-left font-bold">
              <div class="flex items-center gap-2">
                <i class="fas fa-barcode text-blue-500 dark:text-blue-400"></i>
                <%= t('asset_id') %>
              </div>
            </th>
            <th class="px-4 py-4 text-left font-bold">
              <div class="flex items-center gap-2">
                <i class="fas fa-laptop text-green-500 dark:text-green-400"></i>
                <%= t('name') %>
              </div>
            </th>
            <th class="px-4 py-4 text-left font-bold">
              <div class="flex items-center gap-2">
                <i class="fas fa-tag text-purple-500 dark:text-purple-400"></i>
                <%= t('type') %>
              </div>
            </th>
            <th class="px-4 py-4 text-left font-bold">
              <div class="flex items-center gap-2">
                <i class="fas fa-copyright text-orange-500 dark:text-orange-400"></i>
                <%= t('brand') %>
              </div>
            </th>
            <th class="px-4 py-4 text-left font-bold">
              <div class="flex items-center gap-2">
                <i class="fas fa-user text-cyan-500 dark:text-cyan-400"></i>
                <%= t('assigned_to') %>
              </div>
            </th>
            <th class="px-4 py-4 text-left font-bold">
              <div class="flex items-center gap-2">
                <i class="fas fa-info-circle text-indigo-500 dark:text-indigo-400"></i>
                <%= t('status') %>
              </div>
            </th>
            <th class="px-4 py-4 text-left font-bold">
              <div class="flex items-center gap-2">
                <i class="fas fa-cogs text-gray-500 dark:text-gray-400"></i>
                <%= t('actions') %>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <%
            // Use the same status handling logic as the detail view
          %>
          <% items.forEach(item => { %>
            <tr class="border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-900 transition">
              <td class="px-4 py-3 font-mono text-gray-800 dark:text-gray-100"><%= item.cep_brc %></td>
              <td class="px-4 py-3">
                <div>
                  <a href="/items/<%= item.id %>/<%= item.cep_brc %>" class="font-semibold text-blue-700 dark:text-blue-300 hover:underline"><%= item.name %></a>
                  <% if (item.model) { %>
                    <div class="text-xs text-gray-500 dark:text-gray-400"><%= item.model %></div>
                  <% } %>
                </div>
              </td>
              <td class="px-4 py-3">
                <% if (item.type_name) { %>
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 text-xs font-semibold">
                    <i class="fas fa-tag"></i> <%= item.type_name %>
                  </span>
                <% } %>
              </td>
              <td class="px-4 py-3">
                <% if (item.brand_name) { %>
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-200 text-xs font-semibold">
                    <%= item.brand_name %>
                  </span>
                <% } %>
              </td>
              <td class="px-4 py-3">
                <% if (item.assigned_to_name) { %>
                  <div>
                    <a href="/employees/<%= item.assigned_to_id %>" class="inline-flex items-center gap-1 text-gray-800 dark:text-gray-100 hover:underline">
                      <i class="fas fa-user"></i> <%= item.assigned_to_name %>
                    </a>
                    <% if (item.department_name) { %>
                      <div class="text-xs text-gray-500 dark:text-gray-400"><%= item.department_name %></div>
                    <% } %>
                  </div>
                <% } else { %>
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded bg-gray-100 dark:bg-gray-900 text-gray-500 dark:text-gray-400 text-xs font-semibold">
                    <i class="fas fa-user-slash"></i> Não atribuído
                  </span>
                <% } %>
              </td>
              <td class="px-4 py-3">
                <%
                  // Use the same status handling logic as the detail view
                  let statusClass = 'bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-300';
                  let statusIcon = 'fas fa-question-circle';
                  let statusText = 'Unknown';
                  let statusStyle = '';

                  if (item.status_name) {
                    statusText = item.status_name;

                    // Check if we have status data with color/icon information
                    if (typeof item.status_color !== 'undefined' && item.status_color) {
                      // Handle RGB colors
                      if (item.status_color.startsWith('#')) {
                        // Convert hex to RGB for opacity calculations
                        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(item.status_color);
                        if (result) {
                          const r = parseInt(result[1], 16);
                          const g = parseInt(result[2], 16);
                          const b = parseInt(result[3], 16);
                          statusStyle = `background-color: rgba(${r}, ${g}, ${b}, 0.1); color: ${item.status_color}; border: 1px solid rgba(${r}, ${g}, ${b}, 0.3);`;
                          statusClass = ''; // Clear default classes when using custom style
                        }
                      } else {
                        // Fallback to named colors
                        switch(item.status_color) {
                          case 'green':
                            statusClass = 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 border border-green-200 dark:border-green-700';
                            break;
                          case 'yellow':
                            statusClass = 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 border border-yellow-200 dark:border-yellow-700';
                            break;
                          case 'red':
                            statusClass = 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 border border-red-200 dark:border-red-700';
                            break;
                          case 'blue':
                            statusClass = 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-700';
                            break;
                          case 'gray':
                            statusClass = 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600';
                            break;
                          default:
                            statusClass = 'bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 border border-purple-200 dark:border-purple-700';
                        }
                      }
                    } else {
                      // Fallback to pattern matching if no color is available
                      const statusName = item.status_name.toLowerCase();
                      if (statusName.includes('active') || statusName.includes('operational') || statusName.includes('working')) {
                        statusClass = 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 border border-green-200 dark:border-green-700';
                        statusIcon = 'fas fa-check-circle';
                      } else if (statusName.includes('maintenance') || statusName.includes('repair') || statusName.includes('service')) {
                        statusClass = 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 border border-yellow-200 dark:border-yellow-700';
                        statusIcon = 'fas fa-wrench';
                      } else if (statusName.includes('retired') || statusName.includes('disposed') || statusName.includes('end')) {
                        statusClass = 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600';
                        statusIcon = 'fas fa-archive';
                      } else if (statusName.includes('lost') || statusName.includes('missing') || statusName.includes('stolen')) {
                        statusClass = 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 border border-red-200 dark:border-red-700';
                        statusIcon = 'fas fa-times-circle';
                      } else if (statusName.includes('storage') || statusName.includes('available') || statusName.includes('stock')) {
                        statusClass = 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-700';
                        statusIcon = 'fas fa-box';
                      }
                    }

                    // Use database icon if available
                    if (typeof item.status_icon !== 'undefined' && item.status_icon) {
                      statusIcon = item.status_icon;
                    }
                  }
                %>
                <span class="inline-flex items-center gap-2 px-3 py-1 rounded-lg font-medium text-sm shadow <%= statusClass %>" <% if (statusStyle) { %>style="<%= statusStyle %>"<% } %>>
                  <% if (statusIcon.startsWith('fas fa-')) { %>
                    <i class="<%= statusIcon %>"></i>
                  <% } else { %>
                    <span class="text-base"><%= statusIcon %></span>
                  <% } %>
                  <%= statusText %>
                </span>
              </td>
              <td class="px-4 py-3">
                <div class="flex gap-1">
                  <a href="/items/<%= item.id %>/<%= item.cep_brc %>" class="inline-flex items-center justify-center w-8 h-8 rounded bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-800 transition" title="Ver Detalhes">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a href="/items/<%= item.id %>/<%= item.cep_brc %>/edit" class="inline-flex items-center justify-center w-8 h-8 rounded bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 hover:bg-yellow-200 dark:hover:bg-yellow-800 transition" title="Editar">
                    <i class="fas fa-edit"></i>
                  </a>
                  <% if (!item.assigned_to_name) { %>
                    <a href="/items/<%= item.id %>/<%= item.cep_brc %>/assign" class="inline-flex items-center justify-center w-8 h-8 rounded bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 hover:bg-green-200 dark:hover:bg-green-800 transition" title="Atribuir">
                      <i class="fas fa-user-plus"></i>
                    </a>
                  <% } else { %>
                    <form style="display: inline;" method="POST" action="/items/<%= item.id %>/<%= item.cep_brc %>/unassign" class="inline-form" onsubmit="return confirm('Are you sure you want to unassign &quot;<%= item.name %>&quot; from <%= item.assigned_to_name %>?\n\nThis action cannot be undone.')">
                      <button type="submit" class="inline-flex items-center justify-center w-8 h-8 rounded bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-800 transition" title="Remover Atribuição">
                        <i class="fas fa-user-minus"></i>
                      </button>
                    </form>
                  <% } %>
                  <a href="/items/<%= item.id %>/<%= item.cep_brc %>/history" class="inline-flex items-center justify-center w-8 h-8 rounded bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-800 transition" title="Ver Histórico">
                    <i class="fas fa-history"></i>
                  </a>
                </div>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>

    <!-- Results Summary & Pagination -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mt-8">
      <div class="flex flex-col gap-2">
        <span class="text-sm text-gray-700 dark:text-gray-200">
          <i class="fas fa-boxes"></i>
          <%= t('showing') %> <strong id="itemCount"><%= items.length %></strong> <%= t('of') %> <%= typeof totalItems !== 'undefined' ? totalItems : items.length %> <%= t('assets') %>
        </span>
      </div>
      <div class="flex items-center gap-4">
        <% if (typeof currentPage !== 'undefined' && typeof totalPages !== 'undefined') { %>
          <div class="flex items-center gap-2">
            <% if (totalPages > 1) { %>
              <%
                // Build query string with current filters for pagination
                const queryParams = new URLSearchParams();
                if (req.query.q) queryParams.set('q', req.query.q);
                if (req.query.type) queryParams.set('type', req.query.type);
                if (req.query.brand) queryParams.set('brand', req.query.brand);
                if (req.query.status) queryParams.set('status', req.query.status);
                if (req.query.department) queryParams.set('department', req.query.department);
                if (req.query.minPrice) queryParams.set('minPrice', req.query.minPrice);
                if (req.query.maxPrice) queryParams.set('maxPrice', req.query.maxPrice);
                if (req.query.startDate) queryParams.set('startDate', req.query.startDate);
                if (req.query.endDate) queryParams.set('endDate', req.query.endDate);
                if (req.query.perPage) queryParams.set('perPage', req.query.perPage);

                function buildPageUrl(pageNum) {
                  const params = new URLSearchParams(queryParams);
                  params.set('page', pageNum);
                  return '?' + params.toString();
                }
              %>
              <div class="flex items-center space-x-2">
                <% if (currentPage > 1) { %>
                  <a href="<%= buildPageUrl(currentPage - 1) %>" class="px-4 py-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-all duration-200 font-medium text-gray-700 dark:text-gray-200 shadow-sm">
                    <i class="fas fa-chevron-left mr-1"></i> Previous
                  </a>
                <% } %>

                <% for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) { %>
                  <% if (i === currentPage) { %>
                    <span class="px-4 py-2 text-sm bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-bold shadow-lg border border-blue-500"><%= i %></span>
                  <% } else { %>
                    <a href="<%= buildPageUrl(i) %>" class="px-4 py-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-all duration-200 font-medium text-gray-700 dark:text-gray-200 shadow-sm"><%= i %></a>
                  <% } %>
                <% } %>

                <% if (currentPage < totalPages) { %>
                  <a href="<%= buildPageUrl(currentPage + 1) %>" class="px-4 py-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-all duration-200 font-medium text-gray-700 dark:text-gray-200 shadow-sm">
                    Next <i class="fas fa-chevron-right ml-1"></i>
                  </a>
                <% } %>
              </div>
            <% } %>
          </div>
        <% } %>
        <div>
          <select id="itemsPerPage" class="ml-2 px-2 py-1 border border-gray-300 dark:border-gray-700 rounded bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 text-xs">
            <option value="10" <%= perPage === 10 ? 'selected' : '' %>>10</option>
            <option value="20" <%= perPage === 20 ? 'selected' : '' %>>20</option>
            <option value="50" <%= perPage === 50 ? 'selected' : '' %>>50</option>
            <option value="100" <%= perPage === 100 ? 'selected' : '' %>>100</option>
          </select>
          <span class="text-xs text-gray-500 dark:text-gray-400"><%= t('per_page') %></span>
        </div>
      </div>
    </div>
  </div>
<% } else { %>
  <!-- No Items Message -->
  <div class="no-items-message text-center py-20 bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg">
    <div class="mb-6 text-6xl">
      <span class="inline-block animate-bounce">📦</span>
    </div>
    <div class="mb-4 text-4xl text-gray-400 dark:text-gray-500">
      <i class="fas fa-boxes"></i>
    </div>
    <h3 class="text-xl font-bold text-gray-700 dark:text-gray-200 mb-2"><%= t('no_assets_found') %></h3>
    <p class="text-gray-500 dark:text-gray-400 mb-6 max-w-md mx-auto"><%= t('no_assets_match') %></p>
    <div class="flex gap-3 justify-center">
      <button id="clearFiltersBtn" class="px-6 py-3 bg-gradient-to-r from-gray-300 to-gray-400 dark:from-gray-700 dark:to-gray-600 hover:from-gray-400 hover:to-gray-500 dark:hover:from-gray-600 dark:hover:to-gray-500 text-gray-800 dark:text-gray-100 font-semibold rounded-lg transition-all duration-200 flex items-center gap-2 shadow-lg" style="display: none;">
        <i class="fas fa-times"></i> <%= t('clear_all_filters') %>
      </button>
      <a href="/items/new" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold rounded-lg transition-all duration-200 flex items-center gap-2 shadow-lg transform hover:scale-105">
        <i class="fas fa-plus"></i> <%= t('add_first_asset') %>
      </a>
    </div>
  </div>
<% } %>
