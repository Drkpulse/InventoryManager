<div class="report-container">
  <div class="report-header">
    <h1>Unassigned Assets Analytics Report</h1>
    <div class="report-actions">
      <a href="/reports/export-assets?filter=unassigned" class="btn btn-primary">
        <i class="fas fa-download"></i> Export to CSV
      </a>
      <a href="/reports" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Reports
      </a>
    </div>
  </div>

  <%
    // Calculate analytics data
    const totalUnassigned = items ? items.length : 0;
    const totalValue = items ? items.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0) : 0;
    const avgValue = totalUnassigned > 0 ? totalValue / totalUnassigned : 0;

    // Group by type
    const typeBreakdown = {};
    const brandBreakdown = {};
    const ageBreakdown = { '0-30': 0, '31-90': 0, '91-365': 0, '365+': 0 };
    const valueRanges = { 'under_500': 0, '500-1000': 0, '1000-5000': 0, 'over_5000': 0 };

    if (items) {
      items.forEach(item => {
        // Type breakdown
        const type = item.type_name || 'Unknown';
        typeBreakdown[type] = (typeBreakdown[type] || 0) + 1;

        // Brand breakdown
        const brand = item.brand_name || 'Unknown';
        brandBreakdown[brand] = (brandBreakdown[brand] || 0) + 1;

        // Age breakdown (days since acquisition)
        if (item.date_acquired) {
          const daysSince = Math.floor((new Date() - new Date(item.date_acquired)) / (1000 * 60 * 60 * 24));
          if (daysSince <= 30) ageBreakdown['0-30']++;
          else if (daysSince <= 90) ageBreakdown['31-90']++;
          else if (daysSince <= 365) ageBreakdown['91-365']++;
          else ageBreakdown['365+']++;
        }

        // Value ranges
        const price = parseFloat(item.price) || 0;
        if (price < 500) valueRanges['under_500']++;
        else if (price < 1000) valueRanges['500-1000']++;
        else if (price < 5000) valueRanges['1000-5000']++;
        else valueRanges['over_5000']++;
      });
    }

    // Sort breakdowns
    const topTypes = Object.entries(typeBreakdown).sort((a, b) => b[1] - a[1]).slice(0, 5);
    const topBrands = Object.entries(brandBreakdown).sort((a, b) => b[1] - a[1]).slice(0, 5);
  %>

  <!-- Key Metrics -->
  <div class="report-summary">
    <div class="summary-card alert">
      <div class="summary-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h3>Total Unassigned</h3>
      <div class="summary-number"><%= totalUnassigned %></div>
      <div class="summary-detail">Assets requiring assignment</div>
    </div>

    <div class="summary-card value">
      <div class="summary-icon">
        <i class="fas fa-dollar-sign"></i>
      </div>
      <h3>Total Value</h3>
      <div class="summary-number">$<%= totalValue.toLocaleString() %></div>
      <div class="summary-detail">In unassigned assets</div>
    </div>

    <div class="summary-card average">
      <div class="summary-icon">
        <i class="fas fa-calculator"></i>
      </div>
      <h3>Average Value</h3>
      <div class="summary-number">$<%= avgValue.toFixed(0) %></div>
      <div class="summary-detail">Per unassigned asset</div>
    </div>

    <div class="summary-card utilization">
      <div class="summary-icon">
        <i class="fas fa-chart-pie"></i>
      </div>
      <h3>Utilization Gap</h3>
      <div class="summary-number"><%= totalUnassigned %>%</div>
      <div class="summary-detail">Assets not in use</div>
    </div>
  </div>

  <!-- Analytics Dashboard -->
  <div class="analytics-grid">
    <!-- Asset Type Analysis -->
    <div class="analytics-card">
      <h3><i class="fas fa-tags"></i> Unassigned by Asset Type</h3>
      <div class="chart-container">
        <% if (topTypes.length > 0) { %>
          <% topTypes.forEach(([type, count]) => { %>
            <div class="bar-item">
              <div class="bar-label"><%= type %></div>
              <div class="bar-container">
                <div class="bar-fill" style="width: <%= (count / totalUnassigned * 100).toFixed(1) %>%"></div>
                <span class="bar-value"><%= count %> (<%= (count / totalUnassigned * 100).toFixed(1) %>%)</span>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <p class="no-data">No type data available</p>
        <% } %>
      </div>
    </div>

    <!-- Brand Analysis -->
    <div class="analytics-card">
      <h3><i class="fas fa-building"></i> Top Brands Unassigned</h3>
      <div class="chart-container">
        <% if (topBrands.length > 0) { %>
          <% topBrands.forEach(([brand, count]) => { %>
            <div class="bar-item">
              <div class="bar-label"><%= brand %></div>
              <div class="bar-container">
                <div class="bar-fill" style="width: <%= (count / totalUnassigned * 100).toFixed(1) %>%"></div>
                <span class="bar-value"><%= count %> (<%= (count / totalUnassigned * 100).toFixed(1) %>%)</span>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <p class="no-data">No brand data available</p>
        <% } %>
      </div>
    </div>

    <!-- Age Analysis -->
    <div class="analytics-card">
      <h3><i class="fas fa-clock"></i> Days Since Acquisition</h3>
      <div class="chart-container">
        <div class="bar-item">
          <div class="bar-label">0-30 days</div>
          <div class="bar-container">
            <div class="bar-fill recent" style="width: <%= totalUnassigned > 0 ? (ageBreakdown['0-30'] / totalUnassigned * 100).toFixed(1) : 0 %>%"></div>
            <span class="bar-value"><%= ageBreakdown['0-30'] %></span>
          </div>
        </div>
        <div class="bar-item">
          <div class="bar-label">31-90 days</div>
          <div class="bar-container">
            <div class="bar-fill moderate" style="width: <%= totalUnassigned > 0 ? (ageBreakdown['31-90'] / totalUnassigned * 100).toFixed(1) : 0 %>%"></div>
            <span class="bar-value"><%= ageBreakdown['31-90'] %></span>
          </div>
        </div>
        <div class="bar-item">
          <div class="bar-label">91-365 days</div>
          <div class="bar-container">
            <div class="bar-fill warning" style="width: <%= totalUnassigned > 0 ? (ageBreakdown['91-365'] / totalUnassigned * 100).toFixed(1) : 0 %>%"></div>
            <span class="bar-value"><%= ageBreakdown['91-365'] %></span>
          </div>
        </div>
        <div class="bar-item">
          <div class="bar-label">Over 1 year</div>
          <div class="bar-container">
            <div class="bar-fill critical" style="width: <%= totalUnassigned > 0 ? (ageBreakdown['365+'] / totalUnassigned * 100).toFixed(1) : 0 %>%"></div>
            <span class="bar-value"><%= ageBreakdown['365+'] %></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Value Distribution -->
    <div class="analytics-card">
      <h3><i class="fas fa-money-bill-wave"></i> Value Distribution</h3>
      <div class="chart-container">
        <div class="bar-item">
          <div class="bar-label">Under $500</div>
          <div class="bar-container">
            <div class="bar-fill low-value" style="width: <%= totalUnassigned > 0 ? (valueRanges['under_500'] / totalUnassigned * 100).toFixed(1) : 0 %>%"></div>
            <span class="bar-value"><%= valueRanges['under_500'] %></span>
          </div>
        </div>
        <div class="bar-item">
          <div class="bar-label">$500 - $1,000</div>
          <div class="bar-container">
            <div class="bar-fill mid-value" style="width: <%= totalUnassigned > 0 ? (valueRanges['500-1000'] / totalUnassigned * 100).toFixed(1) : 0 %>%"></div>
            <span class="bar-value"><%= valueRanges['500-1000'] %></span>
          </div>
        </div>
        <div class="bar-item">
          <div class="bar-label">$1,000 - $5,000</div>
          <div class="bar-container">
            <div class="bar-fill high-value" style="width: <%= totalUnassigned > 0 ? (valueRanges['1000-5000'] / totalUnassigned * 100).toFixed(1) : 0 %>%"></div>
            <span class="bar-value"><%= valueRanges['1000-5000'] %></span>
          </div>
        </div>
        <div class="bar-item">
          <div class="bar-label">Over $5,000</div>
          <div class="bar-container">
            <div class="bar-fill premium-value" style="width: <%= totalUnassigned > 0 ? (valueRanges['over_5000'] / totalUnassigned * 100).toFixed(1) : 0 %>%"></div>
            <span class="bar-value"><%= valueRanges['over_5000'] %></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recommendations -->
  <div class="recommendations-section">
    <h2><i class="fas fa-lightbulb"></i> Recommendations & Insights</h2>
    <div class="recommendations-grid">
      <% if (ageBreakdown['365+'] > 0) { %>
        <div class="recommendation-card urgent">
          <h4><i class="fas fa-exclamation-circle"></i> Urgent Action Required</h4>
          <p><%= ageBreakdown['365+'] %> assets have been unassigned for over a year. Consider reviewing if these assets are still needed or can be disposed of.</p>
        </div>
      <% } %>

      <% if (totalValue > 50000) { %>
        <div class="recommendation-card financial">
          <h4><i class="fas fa-dollar-sign"></i> Financial Impact</h4>
          <p>$<%= totalValue.toLocaleString() %> worth of assets are sitting idle. Prioritize assignment to maximize ROI.</p>
        </div>
      <% } %>

      <% if (topTypes.length > 0 && topTypes[0][1] > totalUnassigned * 0.4) { %>
        <div class="recommendation-card category">
          <h4><i class="fas fa-chart-bar"></i> Category Focus</h4>
          <p><%= topTypes[0][0] %> represents <%= ((topTypes[0][1] / totalUnassigned) * 100).toFixed(1) %>% of unassigned assets. Focus assignment efforts on this category.</p>
        </div>
      <% } %>

      <div class="recommendation-card process">
        <h4><i class="fas fa-cogs"></i> Process Improvement</h4>
        <p>Consider implementing automatic assignment workflows or regular review cycles to prevent asset accumulation.</p>
      </div>
    </div>
  </div>

  <!-- Action Items -->
  <div class="action-section">
    <h2><i class="fas fa-tasks"></i> Quick Actions</h2>
    <div class="action-buttons">
      <a href="/items?assigned=unassigned" class="btn btn-primary">
        <i class="fas fa-list"></i> View All Unassigned Items
      </a>
      <a href="/employees" class="btn btn-secondary">
        <i class="fas fa-users"></i> View Employees for Assignment
      </a>
      <a href="/items/bulk-assign" class="btn btn-info">
        <i class="fas fa-user-friends"></i> Bulk Assignment Tool
      </a>
      <a href="/reports/asset-utilization" class="btn btn-success">
        <i class="fas fa-chart-line"></i> Full Utilization Report
      </a>
    </div>
  </div>

  <% if (totalUnassigned === 0) { %>
    <div class="empty-state success">
      <div class="empty-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3>Excellent Asset Management!</h3>
      <p>All assets are currently assigned. Your inventory utilization is at 100%.</p>
      <a href="/items/new" class="btn btn-primary">
        <i class="fas fa-plus"></i> Add New Asset
      </a>
    </div>
  <% } %>
</div>

<link rel="stylesheet" href="/css/styles.css">
