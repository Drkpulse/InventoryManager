<div class="max-w-4xl mx-auto p-6">
  <!-- Breadcrumbs & Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <nav class="flex items-center text-sm text-gray-500 dark:text-gray-400 mb-2">
        <a href="/references" class="hover:text-blue-600 dark:hover:text-blue-400 flex items-center gap-1">
          <i class="fas fa-cog"></i> References
        </a>
        <i class="fas fa-chevron-right mx-2"></i>
        <a href="/software" class="hover:text-blue-600 dark:hover:text-blue-400 flex items-center gap-1">
          Software
        </a>
        <i class="fas fa-chevron-right mx-2"></i>
        <span class="text-gray-700 dark:text-gray-200">Edit</span>
      </nav>
      <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Edit Software</h1>
      <div class="flex items-center gap-4 mt-2">
        <span class="flex items-center gap-2 text-blue-700 dark:text-blue-300 font-semibold">
          <i class="fas fa-laptop-code"></i>
          <%= software.name %>
        </span>
        <% if (software.version) { %>
          <span class="ml-2 text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded font-semibold">v<%= software.version %></span>
        <% } %>
      </div>
    </div>
    <div class="flex gap-2">
      <a href="/software" class="inline-flex items-center px-4 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 font-semibold rounded-md transition">
        <i class="fas fa-arrow-left mr-2"></i> Back to Software
      </a>
      <% if (typeof software.employee_count !== 'undefined' && parseInt(software.employee_count) > 0) { %>
        <a href="/software/<%= software.id %>/assignments" class="inline-flex items-center px-4 py-2 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-800 font-semibold rounded-md transition">
          <i class="fas fa-users mr-2"></i> View Assignments (<%= software.employee_count %>)
        </a>
      <% } %>
    </div>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8">
    <% if (typeof errors !== 'undefined' && errors.length > 0) { %>
      <div class="mb-6 flex items-center gap-2 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-4 py-3 rounded">
        <i class="fas fa-exclamation-triangle"></i>
        <div>
          <strong>Please fix the following errors:</strong>
          <ul class="list-disc pl-5">
            <% errors.forEach(error => { %>
              <li><%= error %></li>
            <% }) %>
          </ul>
        </div>
      </div>
    <% } %>

    <form method="POST" action="/software/<%= software.id %>" id="editSoftwareForm" class="space-y-8" data-no-ajax="true">
      <!-- Software Information Section -->
      <div>
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-800 dark:text-gray-100">
          <i class="fas fa-laptop-code"></i> Software Information
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="md:col-span-2">
            <label for="name" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">Software Name <span class="text-red-500">*</span></label>
            <input type="text" id="name" name="name" value="<%= software.name %>" required
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              placeholder="e.g., Microsoft Office, Adobe Creative Suite">
            <small class="text-gray-500 dark:text-gray-400 flex items-center gap-1 mt-1">
              <i class="fas fa-info-circle"></i>
              The official name of the software product
            </small>
          </div>
          <div>
            <label for="version" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">Version</label>
            <input type="text" id="version" name="version" value="<%= software.version || '' %>"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              placeholder="e.g., 2024, 365, CC 2024">
            <small class="text-gray-500 dark:text-gray-400 flex items-center gap-1 mt-1">
              <i class="fas fa-tag"></i>
              Software version or edition (optional)
            </small>
          </div>
          <div>
            <label for="vendor" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">Vendor/Publisher</label>
            <input type="text" id="vendor" name="vendor" value="<%= software.vendor || '' %>"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              placeholder="e.g., Microsoft, Adobe, Google">
            <small class="text-gray-500 dark:text-gray-400 flex items-center gap-1 mt-1">
              <i class="fas fa-building"></i>
              Software vendor or publisher (optional)
            </small>
          </div>
          <div>
            <label for="license_type" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">License Type</label>
            <select id="license_type" name="license_type"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
              <option value="">Select License Type</option>
              <option value="commercial" <%= software.license_type === 'commercial' ? 'selected' : '' %>>Commercial</option>
              <option value="subscription" <%= software.license_type === 'subscription' ? 'selected' : '' %>>Subscription</option>
              <option value="freeware" <%= software.license_type === 'freeware' ? 'selected' : '' %>>Freeware</option>
              <option value="open-source" <%= software.license_type === 'open-source' ? 'selected' : '' %>>Open Source</option>
              <option value="trial" <%= software.license_type === 'trial' ? 'selected' : '' %>>Trial</option>
            </select>
            <small class="text-gray-500 dark:text-gray-400 flex items-center gap-1 mt-1">
              <i class="fas fa-certificate"></i>
              Type of software license
            </small>
          </div>
          <div>
            <label for="max_licenses" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">Maximum Licenses <span class="text-red-500">*</span></label>
            <input type="number" id="max_licenses" name="max_licenses" min="1" max="999"
              value="<%= software.max_licenses || 1 %>" required
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            <small class="text-gray-500 dark:text-gray-400 flex items-center gap-1 mt-1">
              <i class="fas fa-users"></i>
              Maximum number of users that can use this software simultaneously
            </small>
          </div>
          <div>
            <label for="cost_per_license" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">Cost per License (€)</label>
            <div class="flex items-center">
              <span class="inline-flex items-center px-2 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-700 rounded-l-md text-gray-600 dark:text-gray-300">€</span>
              <input type="number" id="cost_per_license" name="cost_per_license" step="0.01" min="0"
                value="<%= software.cost_per_license || '' %>"
                class="w-full px-4 py-2 border-t border-b border-r border-gray-300 dark:border-gray-700 rounded-r-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
                placeholder="0.00">
            </div>
            <small class="text-gray-500 dark:text-gray-400 flex items-center gap-1 mt-1">
              <i class="fas fa-euro-sign"></i>
              Cost per license in euros (optional)
            </small>
          </div>
          <div class="md:col-span-2">
            <label for="description" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">Description</label>
            <textarea id="description" name="description" rows="4"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              placeholder="Brief description of the software and its purpose..."><%= software.description || '' %></textarea>
            <small class="text-gray-500 dark:text-gray-400 flex items-center gap-1 mt-1">
              <i class="fas fa-sticky-note"></i>
              Optional description of the software's purpose and features
            </small>
          </div>
        </div>
      </div>

      <!-- Current Usage Information -->
      <% if (typeof software.employee_count !== 'undefined') { %>
        <div>
          <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-800 dark:text-gray-100">
            <i class="fas fa-chart-pie"></i> Current Usage
          </h3>
          <%
            const maxLicenses = parseInt(software.max_licenses) || 1;
            const usedCount = parseInt(software.employee_count) || 0;
            const availableCount = maxLicenses - usedCount;
            const usagePercentage = (usedCount / maxLicenses * 100).toFixed(0);

            let statusClass = 'bg-green-500';
            if (usedCount >= maxLicenses) {
              statusClass = 'bg-red-500';
            } else if (usedCount > maxLicenses * 0.8) {
              statusClass = 'bg-yellow-400';
            } else if (usedCount === 0) {
              statusClass = 'bg-gray-400';
            }
          %>
          <div class="bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
              <div class="text-center">
                <div class="text-2xl font-bold text-blue-700 dark:text-blue-300"><%= usedCount %></div>
                <div class="text-xs uppercase text-gray-600 dark:text-gray-400 font-semibold">Currently Used</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold <%= availableCount > 0 ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400' %>"><%= availableCount %></div>
                <div class="text-xs uppercase text-gray-600 dark:text-gray-400 font-semibold"><%= availableCount >= 0 ? 'Available' : 'Over Limit' %></div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-gray-700 dark:text-gray-200"><%= maxLicenses %></div>
                <div class="text-xs uppercase text-gray-600 dark:text-gray-400 font-semibold">Total Licenses</div>
              </div>
            </div>
            <div class="w-full h-3 bg-gray-200 dark:bg-gray-700 rounded mb-2">
              <div class="<%= statusClass %> h-3 rounded transition-all" style="width: <%= Math.min(usagePercentage, 100) %>%"></div>
            </div>
            <div class="text-center text-xs text-gray-600 dark:text-gray-400 font-semibold mb-2"><%= usagePercentage %>% utilized</div>
            <% if (usedCount > 0) { %>
              <div class="text-center mt-4">
                <a href="/software/<%= software.id %>/assignments" class="inline-flex items-center px-4 py-2 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-800 font-semibold rounded-md transition text-sm">
                  <i class="fas fa-users mr-2"></i> View Current Assignments
                </a>
              </div>
            <% } %>
          </div>
        </div>
      <% } %>

      <!-- Form Actions -->
      <div class="flex flex-wrap gap-2 mt-8">
        <button type="submit" class="inline-flex items-center px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md transition text-lg">
          <i class="fas fa-save mr-2"></i> Update Software
        </button>
        <a href="/software" class="inline-flex items-center px-6 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 font-semibold rounded-md transition text-lg">
          <i class="fas fa-times mr-2"></i> Cancel Changes
        </a>
        <% if (typeof software.employee_count !== 'undefined' && parseInt(software.employee_count) === 0) { %>
          <button type="button" class="inline-flex items-center px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md transition text-lg" onclick="confirmDelete()">
            <i class="fas fa-trash mr-2"></i> Delete Software
          </button>
        <% } %>
      </div>
    </form>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40" id="deleteModal" style="display: none;">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-md w-full p-6">
      <div class="flex items-center gap-3 mb-4">
        <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400 text-2xl"></i>
        <h4 class="text-lg font-bold text-gray-800 dark:text-gray-100">Confirm Software Deletion</h4>
      </div>
      <div class="mb-4">
        <p class="mb-2">Are you sure you want to delete <strong><%= software.name %></strong>?</p>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">This action cannot be undone and will remove all related data.</p>
        <div class="bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded p-3">
          <div class="flex justify-between mb-1">
            <span class="font-semibold text-gray-600 dark:text-gray-300">Software:</span>
            <span class="font-semibold text-gray-800 dark:text-gray-100"><%= software.name %> <% if (software.version) { %>v<%= software.version %><% } %></span>
          </div>
          <% if (software.vendor) { %>
            <div class="flex justify-between">
              <span class="font-semibold text-gray-600 dark:text-gray-300">Vendor:</span>
              <span class="font-semibold text-gray-800 dark:text-gray-100"><%= software.vendor %></span>
            </div>
          <% } %>
        </div>
      </div>
      <div class="flex gap-2 justify-end">
        <button id="confirmDeleteBtn" class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md transition">
          <i class="fas fa-trash mr-2"></i> Delete Software
        </button>
        <button id="cancelDeleteBtn" class="inline-flex items-center px-4 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 font-semibold rounded-md transition">
          <i class="fas fa-times mr-2"></i> Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('editSoftwareForm');
  const maxLicensesInput = document.getElementById('max_licenses');
  const deleteModal = document.getElementById('deleteModal');

  // Auto-focus the software name field
  const nameInput = document.getElementById('name');
  if (nameInput) {
    nameInput.focus();
  }

  // License limit validation
  if (maxLicensesInput) {
    const currentUsage = <%= parseInt(software.employee_count) || 0 %>;

    maxLicensesInput.addEventListener('input', function() {
      const newLimit = parseInt(this.value) || 0;

      if (newLimit < currentUsage && currentUsage > 0) {
        this.classList.add('border-red-500');
        let warning = this.parentNode.querySelector('.license-warning');
        if (!warning) {
          warning = document.createElement('div');
          warning.className = 'license-warning text-red-600 dark:text-red-400 text-sm mt-2 flex items-center gap-2';
          warning.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <span>This software is currently assigned to ${currentUsage} users. Reducing the limit below ${currentUsage} may cause licensing issues.</span>
          `;
          this.parentNode.appendChild(warning);
        }
      } else {
        this.classList.remove('border-red-500');
        const warning = this.parentNode.querySelector('.license-warning');
        if (warning) {
          warning.remove();
        }
      }
    });
  }

  // Form validation
  form.addEventListener('submit', function(event) {
    const requiredFields = form.querySelectorAll('[required]');
    let valid = true;

    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        valid = false;
        field.classList.add('border-red-500');
      } else {
        field.classList.remove('border-red-500');
      }
    });

    if (!valid) {
      event.preventDefault();
      // Show error alert
      const errorAlert = document.createElement('div');
      errorAlert.className = 'mb-6 flex items-center gap-2 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-4 py-3 rounded';
      errorAlert.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        <div>
          <strong>Please fill out all required fields</strong>
          <p>Software name and maximum licenses are required.</p>
        </div>
      `;
      form.insertBefore(errorAlert, form.firstChild);
      setTimeout(() => {
        if (errorAlert.parentNode) {
          errorAlert.remove();
        }
      }, 5000);
      // Focus first invalid field
      const firstInvalid = form.querySelector('[required].border-red-500');
      if (firstInvalid) {
        firstInvalid.focus();
      }
    }
  });

  // Delete confirmation
  window.confirmDelete = function() {
    deleteModal.style.display = 'flex';
  };

  document.getElementById('cancelDeleteBtn')?.addEventListener('click', () => {
    deleteModal.style.display = 'none';
  });

  document.getElementById('confirmDeleteBtn')?.addEventListener('click', () => {
    // Create delete form
    const deleteForm = document.createElement('form');
    deleteForm.method = 'POST';
    deleteForm.action = `/software/<%= software.id %>/delete`;
    document.body.appendChild(deleteForm);
    deleteForm.submit();
  });

  // Close modal when clicking overlay
  deleteModal?.addEventListener('click', function(e) {
    if (e.target === deleteModal) {
      deleteModal.style.display = 'none';
    }
  });

  // Calculate total cost when cost per license changes
  const costInput = document.getElementById('cost_per_license');
  if (costInput && maxLicensesInput) {
    function updateTotalCost() {
      const costPerLicense = parseFloat(costInput.value) || 0;
      const maxLicenses = parseInt(maxLicensesInput.value) || 1;
      const totalCost = costPerLicense * maxLicenses;

      let totalCostDisplay = document.getElementById('totalCostDisplay');
      if (!totalCostDisplay && costPerLicense > 0) {
        totalCostDisplay = document.createElement('div');
        totalCostDisplay.id = 'totalCostDisplay';
        totalCostDisplay.className = 'text-green-700 dark:text-green-400 font-semibold mt-2 flex items-center gap-2 text-sm';
        costInput.parentNode.appendChild(totalCostDisplay);
      }

      if (totalCostDisplay) {
        if (costPerLicense > 0) {
          totalCostDisplay.innerHTML = `
            <i class="fas fa-calculator"></i>
            Total cost for ${maxLicenses} licenses: €${totalCost.toFixed(2)}
          `;
          totalCostDisplay.style.display = 'flex';
        } else {
          totalCostDisplay.style.display = 'none';
        }
      }
    }

    costInput.addEventListener('input', updateTotalCost);
    maxLicensesInput.addEventListener('input', updateTotalCost);
    updateTotalCost();
  }
});
</script>

<style>
/* Edit Software Page Specific Styles */
.software-meta {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-top: 0.5rem;
}

.software-name-display {
  color: var(--primary);
  font-weight: 600;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.software-version-display {
  background: #e9ecef;
  color: #495057;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  font-size: 0.8rem;
  font-weight: 600;
}

/* Usage Overview Styles */
.usage-overview {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 1.5rem;
}

.usage-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 1.5rem;
  margin-bottom: 1.5rem;
}

.usage-stat {
  text-align: center;
}

.stat-number {
  font-size: 2rem;
  font-weight: 700;
  line-height: 1;
  margin-bottom: 0.5rem;
}

.stat-number.primary { color: var(--primary); }
.stat-number.success { color: var(--success); }
.stat-number.danger { color: var(--danger); }
.stat-number.info { color: var(--info); }

.stat-label {
  font-size: 0.85rem;
  color: #666;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.usage-progress {
  margin-bottom: 1.5rem;
}

.usage-bar {
  width: 100%;
  height: 12px;
  background: #e9ecef;
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 0.5rem;
}

.usage-fill {
  height: 100%;
  border-radius: 6px;
  transition: all 0.3s;
}

.usage-fill.available {
  background: linear-gradient(90deg, #28a745, #20c997);
}

.usage-fill.near-limit {
  background: linear-gradient(90deg, #ffc107, #fd7e14);
}

.usage-fill.at-limit {
  background: linear-gradient(90deg, #dc3545, #e63946);
}

.usage-fill.unused {
  background: linear-gradient(90deg, #6c757d, #495057);
}

.usage-percentage {
  text-align: center;
  font-size: 0.9rem;
  color: #666;
  font-weight: 500;
}

.usage-actions {
  padding-top: 1rem;
  border-top: 1px solid #dee2e6;
  text-align: center;
}

/* License Warning Styles */
.license-warning {
  font-size: 0.85rem;
  padding: 0.75rem;
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* Software Info Summary in Modal */
.software-info-summary {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 6px;
  padding: 1rem;
  margin: 1rem 0;
}

.software-info-summary .info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.software-info-summary .info-item:last-child {
  margin-bottom: 0;
}

.software-info-summary .label {
  font-weight: 600;
  color: #666;
}

.software-info-summary .value {
  color: #333;
  font-weight: 500;
}

/* Total Cost Display */
.total-cost-display {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  padding: 0.5rem;
  background: #f0fdf4;
  border: 1px solid #bbf7d0;
  border-radius: 4px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .software-meta {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }

  .usage-stats {
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .stat-number {
    font-size: 1.5rem;
  }

  .form-actions {
    flex-direction: column;
  }

  .form-actions .btn {
    width: 100%;
    justify-content: center;
  }
}

@media (max-width: 480px) {
  .usage-stats {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }

  .header-actions .action-buttons {
    flex-direction: column;
    gap: 0.5rem;
  }

  .header-actions .btn {
    width: 100%;
    justify-content: center;
  }
}

/* Print Styles */
@media print {
  .header-actions,
  .form-actions,
  .usage-actions {
    display: none !important;
  }

  .form-container {
    box-shadow: none !important;
    border: 1px solid #333 !important;
  }

  .section-header {
    color: #333 !important;
  }
}
</style>
