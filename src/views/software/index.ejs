<div class="container mx-auto px-4 py-6">
  <!-- Breadcrumbs & Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <nav class="flex items-center text-sm text-gray-500 dark:text-gray-400 mb-2">
        <a href="/dashboard" class="hover:text-blue-600 dark:hover:text-blue-400 flex items-center gap-1">
          <i class="fas fa-cog"></i> Dashboard
        </a>
        <i class="fas fa-chevron-right mx-2"></i>
        <span class="text-gray-700 dark:text-gray-200">Software</span>
      </nav>
      <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Software Management</h1>
      <div class="flex flex-wrap items-center gap-6 mt-2 text-gray-700 dark:text-gray-300 text-sm">
        <span class="flex items-center gap-2">
          <i class="fas fa-laptop-code"></i>
          <%= software ? software.length : 0 %> software packages
        </span>
        <%
          const totalLicenses = software ? software.reduce((sum, sw) => sum + (parseInt(sw.max_licenses) || 1), 0) : 0;
          const usedLicenses = software ? software.reduce((sum, sw) => sum + (parseInt(sw.employee_count) || 0), 0) : 0;
        %>
        <span class="flex items-center gap-2">
          <i class="fas fa-users"></i>
          <span class="font-semibold"><%= usedLicenses %></span>
          <span class="mx-1 text-gray-400 dark:text-gray-500">/</span>
          <span class="font-semibold"><%= totalLicenses %></span>
          licenses used
        </span>
      </div>
    </div>
    <div class="flex gap-2">
      <button id="exportSoftwareBtn" class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-md transition">
        <i class="fas fa-download mr-2"></i> Export List
      </button>
      <a href="/software/add" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md transition">
        <i class="fas fa-plus mr-2"></i> Add New Software
      </a>
    </div>
  </div>

  <!-- Quick Filters -->
  <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div class="flex flex-wrap gap-2">
      <button class="filter-tab active px-3 py-1 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-200 hover:bg-blue-100 dark:hover:bg-blue-900 transition" data-filter="all">
        <i class="fas fa-list"></i> All Software
      </button>
      <button class="filter-tab px-3 py-1 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-200 hover:bg-green-100 dark:hover:bg-green-900 transition" data-filter="available">
        <i class="fas fa-check-circle"></i> Available
      </button>
      <button class="filter-tab px-3 py-1 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-200 hover:bg-yellow-100 dark:hover:bg-yellow-900 transition" data-filter="full">
        <i class="fas fa-exclamation-triangle"></i> At Limit
      </button>
      <button class="filter-tab px-3 py-1 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition" data-filter="unused">
        <i class="fas fa-user-slash"></i> Unused
      </button>
    </div>
    <div class="flex gap-2 items-center">
      <div class="relative">
        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        <input type="text" id="licenseSearch" placeholder="Search software..." autocomplete="off"
          class="pl-10 pr-3 py-2 rounded-md border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:outline-none transition w-56">
      </div>
      <select id="vendorFilter"
        class="rounded-md border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
        <option value="">All Vendors</option>
        <% if (software) { %>
          <%
            const uniqueVendors = [...new Set(software.map(sw => sw.vendor).filter(Boolean))].sort();
            uniqueVendors.forEach(vendor => {
          %>
            <option value="<%= vendor %>"><%= vendor %></option>
          <% }); %>
        <% } %>
      </select>
    </div>
  </div>

  <!-- Content Section -->
  <div>
    <% if (software && software.length > 0) { %>
      <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-200">
              <th class="px-4 py-3 text-left font-semibold"><i class="fas fa-laptop-code"></i> Software & Version</th>
              <th class="px-4 py-3 text-left font-semibold"><i class="fas fa-building"></i> Vendor</th>
              <th class="px-4 py-3 text-left font-semibold"><i class="fas fa-certificate"></i> License Type</th>
              <th class="px-4 py-3 text-left font-semibold"><i class="fas fa-users"></i> Usage</th>
              <th class="px-4 py-3 text-left font-semibold"><i class="fas fa-euro-sign"></i> Cost</th>
              <th class="px-4 py-3 text-left font-semibold"><i class="fas fa-info-circle"></i> Status</th>
              <th class="px-4 py-3 text-left font-semibold">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% software.forEach(sw => { %>
              <%
                const maxLicenses = parseInt(sw.max_licenses) || 1;
                const usedCount = parseInt(sw.employee_count) || 0;
                const availableCount = maxLicenses - usedCount;
                const usagePercentage = (usedCount / maxLicenses * 100).toFixed(0);

                let statusClass = 'available';
                let statusIcon = 'fas fa-check-circle';
                let statusText = 'Available';

                if (usedCount >= maxLicenses) {
                  statusClass = 'at-limit';
                  statusIcon = 'fas fa-exclamation-triangle';
                  statusText = 'At Limit';
                } else if (usedCount > maxLicenses * 0.8) {
                  statusClass = 'near-limit';
                  statusIcon = 'fas fa-exclamation-circle';
                  statusText = 'Near Limit';
                } else if (usedCount === 0) {
                  statusClass = 'unused';
                  statusIcon = 'fas fa-user-slash';
                  statusText = 'Unused';
                }
              %>
              <tr class="license-row border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-900 transition"
                  data-license-type="<%= sw.license_type || '' %>"
                  data-vendor="<%= sw.vendor || '' %>"
                  data-status="<%= statusClass %>"
                  data-search="<%= (sw.name + ' ' + (sw.vendor || '') + ' ' + (sw.version || '')).toLowerCase() %>">
                <!-- Software Name & Version -->
                <td class="px-4 py-3">
                  <div>
                    <div class="flex items-center gap-2 font-semibold text-gray-800 dark:text-gray-100">
                      <i class="fas fa-laptop-code"></i>
                      <%= sw.name %>
                      <% if (sw.version) { %>
                        <span class="ml-2 text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-0.5 rounded">v<%= sw.version %></span>
                      <% } %>
                    </div>
                    <% if (sw.description) { %>
                      <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 truncate" title="<%= sw.description %>">
                        <%= sw.description.length > 50 ? sw.description.substring(0, 50) + '...' : sw.description %>
                      </div>
                    <% } %>
                  </div>
                </td>
                <!-- Vendor -->
                <td class="px-4 py-3">
                  <% if (sw.vendor) { %>
                    <span class="inline-flex items-center gap-1 bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded px-2 py-0.5 text-xs text-gray-700 dark:text-gray-200">
                      <i class="fas fa-building"></i> <%= sw.vendor %>
                    </span>
                  <% } else { %>
                    <span class="text-gray-400 dark:text-gray-500">-</span>
                  <% } %>
                </td>
                <!-- License Type -->
                <td class="px-4 py-3">
                  <% if (sw.license_type) { %>
                    <span class="inline-flex items-center gap-1 bg-blue-100 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded px-2 py-0.5 text-xs text-blue-800 dark:text-blue-200">
                      <i class="fas fa-certificate"></i> <%= sw.license_type %>
                    </span>
                  <% } else { %>
                    <span class="text-gray-400 dark:text-gray-500">-</span>
                  <% } %>
                </td>
                <!-- Usage with Progress Bar -->
                <td class="px-4 py-3">
                  <div>
                    <div class="flex items-center gap-1 font-semibold">
                      <span class="text-blue-700 dark:text-blue-300"><%= usedCount %></span>
                      <span class="mx-1 text-gray-400 dark:text-gray-500">/</span>
                      <span class="text-gray-700 dark:text-gray-200"><%= maxLicenses %></span>
                    </div>
                    <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded mt-1">
                      <div
                        class="<%=
                          statusClass === 'available' ? 'bg-green-500' :
                          statusClass === 'near-limit' ? 'bg-yellow-400' :
                          statusClass === 'at-limit' ? 'bg-red-500' :
                          'bg-gray-400'
                        %> h-2 rounded transition-all"
                        style="width: <%= Math.min(usagePercentage, 100) %>%"
                        title="<%= usagePercentage %>% used">
                      </div>
                    </div>
                    <div class="text-xs mt-1 <%= statusClass === 'at-limit' || statusClass === 'near-limit' ? 'text-red-600 dark:text-red-400 font-semibold' : statusClass === 'unused' ? 'text-gray-400 dark:text-gray-500' : 'text-gray-600 dark:text-gray-300' %>">
                      <% if (availableCount > 0) { %>
                        <%= availableCount %> available
                      <% } else if (availableCount === 0) { %>
                        At capacity
                      <% } else { %>
                        <%= Math.abs(availableCount) %> over limit
                      <% } %>
                    </div>
                  </div>
                </td>
                <!-- Cost -->
                <td class="px-4 py-3">
                  <% if (sw.cost_per_license) { %>
                    <div>
                      <div class="font-semibold text-green-700 dark:text-green-400">€<%= parseFloat(sw.cost_per_license).toFixed(2) %></div>
                      <div class="text-xs text-gray-500 dark:text-gray-400">Total: €<%= (parseFloat(sw.cost_per_license) * maxLicenses).toFixed(2) %></div>
                    </div>
                  <% } else { %>
                    <span class="text-gray-400 dark:text-gray-500">-</span>
                  <% } %>
                </td>
                <!-- Status -->
                <td class="px-4 py-3">
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-semibold
                    <%= statusClass === 'available' ? 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300' :
                        statusClass === 'near-limit' ? 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300' :
                        statusClass === 'at-limit' ? 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300' :
                        'bg-gray-100 dark:bg-gray-900 text-gray-500 dark:text-gray-400' %>">
                    <i class="<%= statusIcon %>"></i> <%= statusText %>
                  </span>
                  <% if (availableCount < 0) { %>
                    <div class="flex items-center gap-1 text-xs text-red-600 dark:text-red-400 mt-1">
                      <i class="fas fa-exclamation-triangle"></i>
                      Over limit by <%= Math.abs(availableCount) %>
                    </div>
                  <% } %>
                </td>
                <!-- Actions -->
                <td class="px-4 py-3">
                  <div class="flex gap-1">
                    <a href="/software/<%= sw.id %>/edit"
                      class="inline-flex items-center justify-center w-8 h-8 rounded bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300 hover:bg-yellow-200 dark:hover:bg-yellow-800 transition"
                      title="Edit Software">
                      <i class="fas fa-edit"></i>
                    </a>
                    <% if (parseInt(sw.employee_count || 0) > 0) { %>
                      <button type="button"
                        class="inline-flex items-center justify-center w-8 h-8 rounded bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-800 transition"
                        title="View Assignments (<%= sw.employee_count %> users)"
                        onclick="showAssignments('<%= sw.id %>', '<%= sw.name %>')">
                        <i class="fas fa-users"></i>
                      </button>
                    <% } else { %>
                      <button type="button"
                        class="inline-flex items-center justify-center w-8 h-8 rounded bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 hover:bg-green-200 dark:hover:bg-green-800 transition"
                        title="Assign License"
                        onclick="assignLicense('<%= sw.id %>', '<%= sw.name %>', <%= availableCount %>)">
                        <i class="fas fa-user-plus"></i>
                      </button>
                    <% } %>
                    <div class="relative group">
                      <button type="button"
                        class="inline-flex items-center justify-center w-8 h-8 rounded bg-gray-100 dark:bg-gray-900 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-800 transition dropdown-toggle"
                        title="More Options">
                        <i class="fas fa-ellipsis-v"></i>
                      </button>
                      <div class="absolute z-10 hidden group-hover:block bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded shadow-lg mt-2 right-0 min-w-[180px] dropdown-menu">
                        <a href="/software/<%= sw.id %>/duplicate" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-200">
                          <i class="fas fa-copy mr-2"></i> Duplicate Software
                        </a>
                        <a href="/software/<%= sw.id %>/history" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-200">
                          <i class="fas fa-history mr-2"></i> View History
                        </a>
                        <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                        <% if (parseInt(sw.employee_count || 0) === 0) { %>
                          <button type="button" onclick="confirmDelete('<%= sw.name %>', '<%= sw.id %>')"
                            class="block w-full text-left px-4 py-2 hover:bg-red-100 dark:hover:bg-red-900 text-red-700 dark:text-red-300">
                            <i class="fas fa-trash mr-2"></i> Delete Software
                          </button>
                        <% } else { %>
                          <span class="block px-4 py-2 text-gray-400 dark:text-gray-500 cursor-not-allowed">
                            <i class="fas fa-trash mr-2"></i> Delete Software
                          </span>
                        <% } %>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
        <!-- Results Summary -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 px-6 py-4 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-2 text-gray-700 dark:text-gray-300 text-sm">
            <i class="fas fa-laptop-code"></i>
            Showing <strong id="visibleCount"><%= software.length %></strong> of <%= software.length %> software packages
          </div>
          <div class="text-xs text-gray-500 dark:text-gray-400 italic">
            License limits can be changed in the edit page
          </div>
        </div>
      </div>
    <% } else { %>
      <div class="flex flex-col items-center justify-center py-16 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
        <div class="mb-4 text-4xl text-gray-400 dark:text-gray-600">
          <i class="fas fa-laptop-code"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-2">No Software Found</h3>
        <p class="text-gray-500 dark:text-gray-400 mb-4">Start by adding your first software package to track licenses and assignments.</p>
        <div class="flex gap-2">
          <a href="/software/add" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md transition">
            <i class="fas fa-plus mr-2"></i> Add First Software
          </a>
          <a href="#" class="inline-flex items-center px-4 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 font-semibold rounded-md transition">
            <i class="fas fa-cog mr-2"></i> Manage References
          </a>
        </div>
      </div>
    <% } %>
  </div>
</div>
<!-- Keep your modals and scripts as in your original file -->
