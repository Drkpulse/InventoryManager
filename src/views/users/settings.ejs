<div class="max-w-3xl mx-auto p-6">
  <div class="flex items-center justify-between mb-8">
    <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2">
      <i class="fas fa-cog"></i> <%= t('user_settings') %>
    </h1>
    <a href="/" class="inline-flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100 rounded-md font-semibold transition">
      <i class="fas fa-arrow-left mr-2"></i> <%= t('back') %> <%= t('dashboard') %>
    </a>
  </div>

  <% if (locals.success) { %>
    <div class="mb-4 flex items-center gap-2 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-4 py-3 rounded">
      <i class="fas fa-check-circle"></i>
      <%= success %>
    </div>
  <% } %>

  <% if (locals.error) { %>
    <div class="mb-4 flex items-center gap-2 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-4 py-3 rounded">
      <i class="fas fa-exclamation-triangle"></i>
      <%= error %>
    </div>
  <% } %>

  <% if (locals.showUpdated) { %>
    <div class="mb-4 flex items-center gap-2 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-4 py-3 rounded">
      <i class="fas fa-check-circle"></i>
      <%= t('settings_updated') %>
    </div>
  <% } %>

  <!-- Display Settings -->
  <div class="mb-10">
    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-800 dark:text-gray-100">
      <i class="fas fa-palette"></i> <%= t('display_settings') %>
    </h3>
    <form method="POST" action="/users/settings/display" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="theme" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200"><%= t('theme') %></label>
          <select id="theme" name="theme" required
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            <option value="light" <%= (!user.settings || user.settings.theme === 'light') ? 'selected' : '' %>><%= t('light_mode') %></option>
            <option value="dark" <%= (user.settings && user.settings.theme === 'dark') ? 'selected' : '' %>><%= t('dark_mode') %></option>
            <option value="auto" <%= (user.settings && user.settings.theme === 'auto') ? 'selected' : '' %>><%= t('auto_mode') %></option>
          </select>
          <small class="text-gray-500 dark:text-gray-400">Choose your preferred color scheme</small>
        </div>
        <div>
          <label for="language" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200"><%= t('language') %></label>
          <select id="language" name="language" required
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            <option value="en" <%= (!user.settings || user.settings.language === 'en') ? 'selected' : '' %>>ðŸ‡ºðŸ‡¸ English</option>
            <option value="pt-PT" <%= (user.settings && user.settings.language === 'pt-PT') ? 'selected' : '' %>>ðŸ‡µðŸ‡¹ PortuguÃªs (Portugal)</option>
            <option value="es" <%= (user.settings && user.settings.language === 'es') ? 'selected' : '' %>>ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
            <option value="fr" <%= (user.settings && user.settings.language === 'fr') ? 'selected' : '' %>>ðŸ‡«ðŸ‡· FranÃ§ais</option>
          </select>
          <small class="text-gray-500 dark:text-gray-400">Select your preferred language</small>
        </div>
        <div>
          <label for="timezone" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200"><%= t('timezone') %></label>
          <select id="timezone" name="timezone"
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            <option value="UTC" <%= (!user.settings || user.settings.timezone === 'UTC') ? 'selected' : '' %>>UTC</option>
            <option value="Europe/Lisbon" <%= (user.settings && user.settings.timezone === 'Europe/Lisbon') ? 'selected' : '' %>>Europe/Lisbon</option>
            <option value="Europe/Madrid" <%= (user.settings && user.settings.timezone === 'Europe/Madrid') ? 'selected' : '' %>>Europe/Madrid</option>
            <option value="Europe/Paris" <%= (user.settings && user.settings.timezone === 'Europe/Paris') ? 'selected' : '' %>>Europe/Paris</option>
            <option value="America/New_York" <%= (user.settings && user.settings.timezone === 'America/New_York') ? 'selected' : '' %>>America/New_York</option>
          </select>
          <small class="text-gray-500 dark:text-gray-400">Your local timezone for date/time display</small>
        </div>
        <div>
          <label for="items_per_page" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200"><%= t('items_per_page') %></label>
          <select id="items_per_page" name="items_per_page"
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            <option value="10" <%= (user.settings && user.settings.items_per_page === '10') ? 'selected' : '' %>>10</option>
            <option value="20" <%= (!user.settings || user.settings.items_per_page === '20') ? 'selected' : '' %>>20</option>
            <option value="50" <%= (user.settings && user.settings.items_per_page === '50') ? 'selected' : '' %>>50</option>
            <option value="100" <%= (user.settings && user.settings.items_per_page === '100') ? 'selected' : '' %>>100</option>
          </select>
          <small class="text-gray-500 dark:text-gray-400">Number of items to display per page in lists</small>
        </div>
      </div>
      <div class="mt-6">
        <button type="submit" class="inline-flex items-center px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md transition">
          <i class="fas fa-save mr-2"></i> <%= t('save') %> <%= t('display_settings') %>
        </button>
      </div>
    </form>
  </div>

  <!-- Notification Settings -->
  <div class="mb-10">
    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-800 dark:text-gray-100">
      <i class="fas fa-bell"></i> <%= t('notification_settings') %>
    </h3>
    <form method="POST" action="/users/settings/notifications" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="flex items-center gap-2 cursor-pointer">
            <input class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" type="checkbox" id="email_notifications" name="email_notifications"
              <%= (!user.settings || user.settings.email_notifications !== false) ? 'checked' : '' %>>
            <span class="font-semibold text-gray-700 dark:text-gray-200"><i class="fas fa-envelope mr-1"></i> <%= t('email_notifications') %></span>
          </label>
          <small class="text-gray-500 dark:text-gray-400">Receive notifications via email</small>
        </div>
        <div>
          <label class="flex items-center gap-2 cursor-pointer">
            <input class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" type="checkbox" id="browser_notifications" name="browser_notifications"
              <%= (!user.settings || user.settings.browser_notifications !== false) ? 'checked' : '' %>>
            <span class="font-semibold text-gray-700 dark:text-gray-200"><i class="fas fa-desktop mr-1"></i> <%= t('browser_notifications') %></span>
          </label>
          <small class="text-gray-500 dark:text-gray-400">Show browser notifications</small>
        </div>
        <div>
          <label class="flex items-center gap-2 cursor-pointer">
            <input class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" type="checkbox" id="maintenance_alerts" name="maintenance_alerts"
              <%= (!user.settings || user.settings.maintenance_alerts !== false) ? 'checked' : '' %>>
            <span class="font-semibold text-gray-700 dark:text-gray-200"><i class="fas fa-tools mr-1"></i> <%= t('maintenance_alerts') %></span>
          </label>
          <small class="text-gray-500 dark:text-gray-400">Notifications about equipment maintenance</small>
        </div>
        <div>
          <label class="flex items-center gap-2 cursor-pointer">
            <input class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" type="checkbox" id="assignment_notifications" name="assignment_notifications"
              <%= (!user.settings || user.settings.assignment_notifications !== false) ? 'checked' : '' %>>
            <span class="font-semibold text-gray-700 dark:text-gray-200"><i class="fas fa-user-plus mr-1"></i> <%= t('assignment_notifications') %></span>
          </label>
          <small class="text-gray-500 dark:text-gray-400">Notifications about equipment assignments</small>
        </div>
      </div>
      <div class="mt-6">
        <button type="submit" class="inline-flex items-center px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md transition">
          <i class="fas fa-save mr-2"></i> <%= t('save') %> <%= t('notification_settings') %>
        </button>
      </div>
    </form>
  </div>

  <!-- Security Settings -->
  <div>
    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-800 dark:text-gray-100">
      <i class="fas fa-shield-alt"></i> <%= t('security_settings') %>
    </h3>
    <form method="POST" action="/users/settings/security" class="space-y-6 needs-validation" novalidate>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="current_password" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200"><%= t('current_password') %></label>
          <input type="password" id="current_password" name="current_password" required
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
          <div class="invalid-feedback text-red-600 text-sm mt-1">Please enter your current password.</div>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="new_password" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200"><%= t('new_password') %></label>
          <input type="password" id="new_password" name="new_password" minlength="8" required
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
          <div class="invalid-feedback text-red-600 text-sm mt-1">Password must be at least 8 characters long.</div>
          <small class="text-gray-500 dark:text-gray-400">Minimum 8 characters, include letters and numbers</small>
        </div>
        <div>
          <label for="confirm_password" class="block font-semibold mb-1 text-gray-700 dark:text-gray-200"><%= t('confirm_password') %></label>
          <input type="password" id="confirm_password" name="confirm_password" required
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
          <div class="invalid-feedback text-red-600 text-sm mt-1">Passwords do not match.</div>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="flex items-center gap-2 cursor-pointer">
            <input class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" type="checkbox" id="session_timeout" name="session_timeout"
              <%= (user.settings && user.settings.session_timeout) ? 'checked' : '' %>>
            <span class="font-semibold text-gray-700 dark:text-gray-200"><i class="fas fa-clock mr-1"></i> <%= t('session_timeout') %></span>
          </label>
          <small class="text-gray-500 dark:text-gray-400">Automatically log out after 30 minutes of inactivity</small>
        </div>
        <div>
          <label class="flex items-center gap-2 cursor-pointer">
            <input class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500" type="checkbox" id="two_factor_auth" name="two_factor_auth"
              <%= (user.settings && user.settings.two_factor_auth) ? 'checked' : '' %>>
            <span class="font-semibold text-gray-700 dark:text-gray-200"><i class="fas fa-lock mr-1"></i> <%= t('two_factor_auth') %></span>
          </label>
          <small class="text-gray-500 dark:text-gray-400">Enable 2FA for enhanced security (coming soon)</small>
        </div>
      </div>
      <div class="mt-6">
        <button type="submit" class="inline-flex items-center px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md transition">
          <i class="fas fa-key mr-2"></i> Change Password
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// Form validation
(function() {
  'use strict';
  window.addEventListener('load', function() {
    var forms = document.getElementsByClassName('needs-validation');
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();

// Password confirmation validation
document.getElementById('confirm_password').addEventListener('input', function() {
  const password = document.getElementById('new_password').value;
  const confirmPassword = this.value;

  if (password !== confirmPassword) {
    this.setCustomValidity('Passwords do not match');
  } else {
    this.setCustomValidity('');
  }
});

// Theme change preview
document.getElementById('theme').addEventListener('change', function() {
  const body = document.body;
  body.setAttribute('data-theme', this.value);
});

// Language change handler - reload page to apply translations
document.getElementById('language').addEventListener('change', function() {
  // Show a preview message about language change
  const currentLang = this.value;
  const messages = {
    'en': 'Language will be changed to English after saving.',
    'pt-PT': 'O idioma serÃ¡ alterado para PortuguÃªs apÃ³s guardar.',
    'es': 'El idioma se cambiarÃ¡ a EspaÃ±ol despuÃ©s de guardar.',
    'fr': 'La langue sera changÃ©e en FranÃ§ais aprÃ¨s sauvegarde.'
  };

  // You could show this message in a small tooltip or notification
  console.log(messages[currentLang] || messages['en']);
});
</script>
